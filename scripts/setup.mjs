#!/usr/bin/env node
/**
 * CC Orchestrator Setup Script
 * API í‚¤ ì…ë ¥ ë° í™˜ê²½ ì„¤ì •
 */

import * as readline from 'readline';
import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, '..');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
});

function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, (answer) => {
      resolve(answer.trim());
    });
  });
}

function questionHidden(prompt) {
  return new Promise((resolve) => {
    process.stdout.write(prompt);

    const stdin = process.stdin;
    const wasRaw = stdin.isRaw;

    stdin.setRawMode(true);
    stdin.resume();
    stdin.setEncoding('utf8');

    let input = '';

    const onData = (char) => {
      if (char === '\n' || char === '\r') {
        stdin.setRawMode(wasRaw);
        stdin.removeListener('data', onData);
        process.stdout.write('\n');
        resolve(input);
      } else if (char === '\u0003') {
        // Ctrl+C
        process.exit();
      } else if (char === '\u007F' || char === '\b') {
        // Backspace
        if (input.length > 0) {
          input = input.slice(0, -1);
          process.stdout.write('\b \b');
        }
      } else {
        input += char;
        process.stdout.write('*');
      }
    };

    stdin.on('data', onData);
  });
}

async function main() {
  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘           CC Orchestrator - Claude Code Multi-Model Orchestrator       â•‘');
  console.log('â•‘                        Setup Wizard                         â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  console.log('ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” CC Orchestrator MCP ì„œë²„ ì„¤ì •ì„ ë„ì™€ì¤ë‹ˆë‹¤.\n');
  console.log('í•„ìš”í•œ API í‚¤:');
  console.log('  - OpenAI API Key (GPT ëª¨ë¸ìš©)');
  console.log('  - Google API Key (Gemini ëª¨ë¸ìš©)');
  console.log('  - Anthropic API Key (Claude ëª¨ë¸ìš©)\n');
  console.log('ì°¸ê³ : ì¼ë¶€ API í‚¤ê°€ ì—†ì–´ë„ í•´ë‹¹ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë©ë‹ˆë‹¤.\n');
  console.log('â”€'.repeat(60) + '\n');

  // API í‚¤ ì…ë ¥ ë°›ê¸°
  const openaiKey = await question('OpenAI API Key (Enter to skip): ');
  const googleKey = await question('Google API Key (Enter to skip): ');
  const anthropicKey = await question('Anthropic API Key (Enter to skip): ');

  console.log('\nâ”€'.repeat(60));

  // ì…ë ¥ í™•ì¸
  console.log('\nì…ë ¥ëœ API í‚¤:');
  console.log(`  OpenAI:    ${openaiKey ? 'âœ“ ì„¤ì •ë¨' : 'âœ— ê±´ë„ˆëœ€'}`);
  console.log(`  Google:    ${googleKey ? 'âœ“ ì„¤ì •ë¨' : 'âœ— ê±´ë„ˆëœ€'}`);
  console.log(`  Anthropic: ${anthropicKey ? 'âœ“ ì„¤ì •ë¨' : 'âœ— ê±´ë„ˆëœ€'}`);

  if (!openaiKey && !googleKey && !anthropicKey) {
    console.log('\nâš ï¸  ê²½ê³ : API í‚¤ê°€ í•˜ë‚˜ë„ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    console.log('   ì—ì´ì „íŠ¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ìµœì†Œ í•˜ë‚˜ì˜ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n');
  }

  const confirm = await question('\nì´ ì„¤ì •ìœ¼ë¡œ ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): ');

  if (confirm.toLowerCase() === 'n') {
    console.log('\nì„¤ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n');
    rl.close();
    process.exit(0);
  }

  // .env íŒŒì¼ ìƒì„±
  console.log('\nğŸ“ .env íŒŒì¼ ìƒì„± ì¤‘...');

  const envContent = `# CC Orchestrator API Keys
# Generated by setup script

# OpenAI API Key (GPT ëª¨ë¸ìš© - oracle ì—­í• )
OPENAI_API_KEY=${openaiKey}

# Google API Key (Gemini ëª¨ë¸ìš© - frontend-engineer, document-writer, multimodal-analyzer ì—­í• )
GOOGLE_API_KEY=${googleKey}

# Anthropic API Key (Claude ëª¨ë¸ìš© - librarian ì—­í• )
ANTHROPIC_API_KEY=${anthropicKey}

# Server Configuration
LOG_LEVEL=info
NODE_ENV=production
CC Orchestrator_MAX_PARALLEL_AGENTS=5
CC Orchestrator_TIMEOUT_SECONDS=300
`;

  const envPath = path.join(rootDir, '.env');
  fs.writeFileSync(envPath, envContent);
  console.log('   âœ“ .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');

  // npm install
  console.log('\nğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...');
  try {
    execSync('npm install', { cwd: rootDir, stdio: 'inherit' });
    console.log('   âœ“ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ');
  } catch (error) {
    console.error('   âœ— ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨');
    rl.close();
    process.exit(1);
  }

  // npm run build
  console.log('\nğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ ì¤‘...');
  try {
    execSync('npm run build', { cwd: rootDir, stdio: 'inherit' });
    console.log('   âœ“ ë¹Œë“œ ì™„ë£Œ');
  } catch (error) {
    console.error('   âœ— ë¹Œë“œ ì‹¤íŒ¨');
    rl.close();
    process.exit(1);
  }

  // Claude Code ì„¤ì • ì•ˆë‚´
  console.log('\n' + 'â•'.repeat(60));
  console.log('\nâœ… CC Orchestrator ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n');
  console.log('ë‹¤ìŒ ë‹¨ê³„: Claude Codeì— MCP ì„œë²„ë¥¼ ë“±ë¡í•˜ì„¸ìš”.\n');

  console.log('ğŸ“‹ Claude Desktop ì„¤ì • íŒŒì¼ ìœ„ì¹˜:');
  console.log('   Windows: %APPDATA%\\Claude\\claude_desktop_config.json');
  console.log('   macOS:   ~/Library/Application Support/Claude/claude_desktop_config.json\n');

  console.log('ğŸ“ ë‹¤ìŒ ë‚´ìš©ì„ ì„¤ì • íŒŒì¼ì— ì¶”ê°€í•˜ì„¸ìš”:\n');

  const configExample = {
    mcpServers: {
      cc-orchestrator: {
        command: 'node',
        args: [path.join(rootDir, 'dist', 'index.js').replace(/\\/g, '\\\\')],
        env: {
          OPENAI_API_KEY: openaiKey || 'your-openai-key',
          GOOGLE_API_KEY: googleKey || 'your-google-key',
          ANTHROPIC_API_KEY: anthropicKey || 'your-anthropic-key',
        },
      },
    },
  };

  console.log(JSON.stringify(configExample, null, 2));

  console.log('\nâš ï¸  ì„¤ì • í›„ Claude Codeë¥¼ ì¬ì‹œì‘í•˜ì„¸ìš”.');
  console.log('\n' + 'â•'.repeat(60) + '\n');

  rl.close();
}

main().catch((error) => {
  console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
  rl.close();
  process.exit(1);
});
